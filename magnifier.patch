From 70844bd4670ff74a413c8fdbf5306398c9ac7e1d Mon Sep 17 00:00:00 2001
From: mochangming <mochangming@xiaomi.com>
Date: Wed, 30 Oct 2013 20:32:33 +0800
Subject: [PATCH] magnifier patch

Change-Id: Idebf751b70678ae864caac2836e8e488da53462e
---
 .../smali/android/content/ClipboardManager.smali   |   40 +++++++++
 .../smali/android/widget/TextView.smali            |   95 +++++++++++++++-----
 .../smali/com/android/server/ServerThread.smali    |   17 ++++
 3 files changed, 130 insertions(+), 22 deletions(-)

--- a/framework.jar.out/smali/android/content/ClipboardManager.smali
+++ b/framework.jar.out/smali/android/content/ClipboardManager.smali
@@ -488,6 +488,8 @@
 
     .prologue
     :try_start_0
+    invoke-direct {p0, p1}, Landroid/content/ClipboardManager;->addClipDataExtra(Landroid/content/ClipData;)V
+
     invoke-static {}, Landroid/content/ClipboardManager;->getService()Landroid/content/IClipboard;
 
     move-result-object v0
@@ -505,6 +507,44 @@
     goto :goto_0
 .end method
 
+.method private addClipDataExtra(Landroid/content/ClipData;)V
+    .locals 3
+    .parameter "clip"
+    .annotation build Landroid/annotation/MiuiHook;
+        value = .enum Landroid/annotation/MiuiHook$MiuiHookType;->NEW_METHOD:Landroid/annotation/MiuiHook$MiuiHookType;
+    .end annotation
+
+    .prologue
+    if-eqz p1, :cond_0
+
+    invoke-virtual {p1}, Landroid/content/ClipData;->getItemCount()I
+
+    move-result v0
+
+    if-lez v0, :cond_0
+
+    invoke-static {}, Lmiui/content/ClipServiceManagerExtra;->getInstance()Lmiui/content/ClipServiceManagerExtra;
+
+    move-result-object v0
+
+    const/4 v1, 0x0
+
+    invoke-virtual {p1, v1}, Landroid/content/ClipData;->getItemAt(I)Landroid/content/ClipData$Item;
+
+    move-result-object v1
+
+    iget-object v2, p0, Landroid/content/ClipboardManager;->mContext:Landroid/content/Context;
+
+    invoke-virtual {v1, v2}, Landroid/content/ClipData$Item;->coerceToText(Landroid/content/Context;)Ljava/lang/CharSequence;
+
+    move-result-object v1
+
+    invoke-virtual {v0, v1}, Lmiui/content/ClipServiceManagerExtra;->addData(Ljava/lang/CharSequence;)V
+
+    :cond_0
+    return-void
+.end method
+
 .method public setText(Ljava/lang/CharSequence;)V
     .locals 1
     .parameter "text"
--- a/framework.jar.out/smali/android/widget/TextView.smali
+++ b/framework.jar.out/smali/android/widget/TextView.smali
@@ -7183,8 +7183,36 @@
     goto :goto_2
 .end method
 
+.method private istextChanged(Ljava/lang/CharSequence;)Z
+    .locals 2
+    .parameter "text"
+
+    .prologue
+    move-object/from16 v0, p0
+
+    iget-object v1, v0, Landroid/widget/TextView;->mText:Ljava/lang/CharSequence;
+
+    move-object/from16 v0, p1
+
+    invoke-virtual {v0, v1}, Ljava/lang/Object;->equals(Ljava/lang/Object;)Z
+
+    move-result v0
+
+    if-nez v0, :cond_0
+
+    const/16 v0, 0x1
+
+    :goto_0
+    return v0
+
+    :cond_0
+    const/16 v0, 0x0
+
+    goto :goto_0
+.end method
+
 .method private setText(Ljava/lang/CharSequence;Landroid/widget/TextView$BufferType;ZI)V
-    .locals 22
+    .locals 23
     .parameter "text"
     .parameter "type"
     .parameter "notifyBefore"
@@ -7207,6 +7235,11 @@
     move-result-object p1
 
     :cond_1
+    invoke-direct/range {p0 .. p1}, Landroid/widget/TextView;->istextChanged(Ljava/lang/CharSequence;)Z
+
+    move-result v22
+
+    .local v22, textChanged:Z
     move-object/from16 v0, p0
 
     iget-boolean v4, v0, Landroid/widget/TextView;->mUserSetTextScaleX:Z
@@ -7833,6 +7866,8 @@
     invoke-direct/range {p0 .. p0}, Landroid/widget/TextView;->checkForRelayout()V
 
     :cond_19
+    if-eqz v22, :cond_miui_0
+
     const/4 v4, 0x0
 
     move-object/from16 v0, p0
@@ -7845,6 +7880,7 @@
 
     invoke-virtual {v0, v1, v4, v2, v3}, Landroid/widget/TextView;->sendOnTextChanged(Ljava/lang/CharSequence;III)V
 
+    :cond_miui_0
     const/4 v4, 0x0
 
     move-object/from16 v0, p0
@@ -19303,15 +19339,15 @@
 
     iget-object v3, p0, Landroid/widget/TextView;->mEditor:Landroid/widget/Editor;
 
-    iget-object v3, v3, Landroid/widget/Editor;->mSelectionModifierCursorController:Landroid/widget/Editor$SelectionModifierCursorController;
+    iget-object v3, v3, Landroid/widget/Editor;->mSelectionModifierCursorController:Landroid/widget/MiuiCursorController;
 
     if-eqz v3, :cond_1
 
     iget-object v3, p0, Landroid/widget/TextView;->mEditor:Landroid/widget/Editor;
 
-    iget-object v3, v3, Landroid/widget/Editor;->mSelectionModifierCursorController:Landroid/widget/Editor$SelectionModifierCursorController;
+    iget-object v3, v3, Landroid/widget/Editor;->mSelectionModifierCursorController:Landroid/widget/MiuiCursorController;
 
-    invoke-virtual {v3}, Landroid/widget/Editor$SelectionModifierCursorController;->isSelectionStartDragged()Z
+    invoke-virtual {v3}, Landroid/widget/MiuiCursorController;->isSelectionStartDragged()Z
 
     move-result v3
 
@@ -20045,7 +20081,13 @@
 
     iget-object v7, p0, Landroid/widget/TextView;->mEditor:Landroid/widget/Editor;
 
-    invoke-virtual {v7, p1}, Landroid/widget/Editor;->onTouchEvent(Landroid/view/MotionEvent;)V
+    invoke-virtual {v7, p1}, Landroid/widget/Editor;->onTouchEvent(Landroid/view/MotionEvent;)Z
+
+    move-result v7
+
+    if-eqz v7, :cond_0
+
+    return v8
 
     :cond_0
     invoke-super {p0, p1}, Landroid/view/View;->onTouchEvent(Landroid/view/MotionEvent;)Z
@@ -20346,6 +20388,28 @@
     return-void
 .end method
 
+.method private longClickFeedback()V
+    .locals 2
+
+    .prologue
+    iget-object v1, p0, Landroid/widget/TextView;->mEditor:Landroid/widget/Editor;
+
+    if-eqz v1, :cond_0
+
+    iget-object v1, p0, Landroid/widget/TextView;->mEditor:Landroid/widget/Editor;
+
+    const/4 v0, 0x1
+
+    iput-boolean v0, v1, Landroid/widget/Editor;->mDiscardNextActionUp:Z
+
+    :cond_0
+    const/4 v0, 0x0
+
+    invoke-virtual {p0, v0}, Landroid/widget/TextView;->performHapticFeedback(I)Z
+
+    return-void
+.end method
+
 .method public performLongClick()Z
     .locals 3
 
@@ -20359,9 +20423,13 @@
 
     if-eqz v1, :cond_0
 
+    invoke-direct {p0}, Landroid/widget/TextView;->longClickFeedback()V
+
     const/4 v0, 0x1
 
     :cond_0
+    if-nez v0, :cond_1
+
     iget-object v1, p0, Landroid/widget/TextView;->mEditor:Landroid/widget/Editor;
 
     if-eqz v1, :cond_1
@@ -20375,23 +20443,6 @@
     or-int/2addr v0, v1
 
     :cond_1
-    if-eqz v0, :cond_2
-
-    const/4 v1, 0x0
-
-    invoke-virtual {p0, v1}, Landroid/widget/TextView;->performHapticFeedback(I)Z
-
-    iget-object v1, p0, Landroid/widget/TextView;->mEditor:Landroid/widget/Editor;
-
-    if-eqz v1, :cond_2
-
-    iget-object v1, p0, Landroid/widget/TextView;->mEditor:Landroid/widget/Editor;
-
-    const/4 v2, 0x1
-
-    iput-boolean v2, v1, Landroid/widget/Editor;->mDiscardNextActionUp:Z
-
-    :cond_2
     return v0
 .end method
 
--- a/services.jar.out/smali/com/android/server/ServerThread.smali
+++ b/services.jar.out/smali/com/android/server/ServerThread.smali
@@ -52,6 +52,21 @@
     return-void
 .end method
 
+.method private addClipServiceExtra()V
+    .locals 2
+
+    .prologue
+    const-string v0, "miui.clipserviceext"
+
+    new-instance v1, Lcom/miui/server/ClipServiceExtra;
+
+    invoke-direct {v1}, Lcom/miui/server/ClipServiceExtra;-><init>()V
+
+    invoke-static {v0, v1}, Landroid/os/ServiceManager;->addService(Ljava/lang/String;Landroid/os/IBinder;)V
+
+    return-void
+.end method
+
 
 # virtual methods
 .method reportWtf(Ljava/lang/String;Ljava/lang/Throwable;)V
@@ -1189,6 +1204,8 @@
     invoke-direct {v9, v5}, Lcom/android/server/ClipboardService;-><init>(Landroid/content/Context;)V
 
     invoke-static {v7, v9}, Landroid/os/ServiceManager;->addService(Ljava/lang/String;Landroid/os/IBinder;)V
+
+    invoke-direct/range {p0 .. p0}, Lcom/android/server/ServerThread;->addClipServiceExtra()V
     :try_end_1d
     .catch Ljava/lang/Throwable; {:try_start_1d .. :try_end_1d} :catch_b
 
-- 
1.7.9.5

